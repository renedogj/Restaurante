<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Reservas</title>
		<link rel="stylesheet" type="text/css" href="css/contenedora.css">
		<link rel="stylesheet" type="text/css" href="css/header.css">
		<link rel="stylesheet" type="text/css" href="css/reservas.css">

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	</head>
	<body onresize="ajustarTamaño()">
		<script src="https://www.gstatic.com/firebasejs/8.4.0/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.4.0/firebase-analytics.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.4.0/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.4.0/firebase-database.js"></script>
		<script>
			var firebaseConfig = {
				apiKey: "AIzaSyDuU1dXAPfANThrSK316lY9nPIDZvN8T68",
				authDomain: "restaurante-358d8.firebaseapp.com",
				databaseURL: "https://restaurante-358d8-default-rtdb.firebaseio.com",
				projectId: "restaurante-358d8",
				storageBucket: "restaurante-358d8.appspot.com",
				messagingSenderId: "966943328871",
				appId: "1:966943328871:web:5aff94344e5db285a862c2",
				measurementId: "G-D21XTDESW6"
			};

			// Initialize Firebase
			firebase.initializeApp(firebaseConfig);
			firebase.analytics();

			firebase.auth().onAuthStateChanged(function(user) {
				if(user){
					var displayName = user.displayName;
					var email = user.email;
					var emailVerified = user.emailVerified;
					var photoURL = user.photoURL;
					var isAnonymous = user.isAnonymous;
					var uid = user.uid;
					var providerData = user.providerData;
					//firebase.database().ref('Users/'+user.uid).set(user.uid);
					//$(".dropdown-content").empty();
					//$(".dropdown-content").html("<a class='logout' onclick='cerrarSesion()'>Cerrar Sesión</a>");
				}else{
					//$(".dropdown-content").empty();
					//$(".dropdown-content").html("<a class='login' href='inicioSesion.html'>Iniciar Sesión</a>");
				}
			});

			function registrarse(){
				var nombre = document.querySelector("#nombre").value;
				var apellidos = document.querySelector("#apellidos").value;
				var fechaNacimiento = document.querySelector("#fechaNacimiento").value;
				var email = document.querySelector("#correo").value;
				var password = document.querySelector("#password").value;
				var confirmarPassword = document.querySelector("#confirmarPassword").value;

				if(password == confirmarPassword){
					firebase.auth().createUserWithEmailAndPassword(email, password)
						.then((userCredential) => {
							var user = userCredential.user;

							//Subir usuario a realTime dataBase
							firebase.database().ref('Users/').child(user.uid).set({
								nombre: nombre,
								apellidos: apellidos,
								fechaNacimiento: fechaNacimiento,
								email: email,
							}, (error) => {
								if (error) {
									console.log("Se ha producido un error al registrar al nuevo usuario");
								} else {
									console.log("Todo bien");
									document.querySelector("#nombre").value = "";
									document.querySelector("#apellidos").value = "";
									document.querySelector("#fechaNacimiento").value = "";
									document.querySelector("#correo").value = "";
									document.querySelector("#password").value = "";
									document.querySelector("#confirmarPassword").value = "";
								}
							});
						})
						.catch((error) => {
							var errorCode = error.code;
							console.log(errorCode)
							var errorMessage = error.message;
							console.log(errorMessage)
						});
				} else {
					console.log("Las contraseñas no coinciden")
				}
			}

			function cerrarSesion(){
				firebase.auth().signOut();
			}
		</script>
		<header class="header">
			
		</header>
		<div class="contenedora">
			<div class="reservas">
				<h1>Rerservas</h1>
				<div class="div-seleccionarDia">
					<input id="fechaReserva" type="date" name="dateReserva" max="2100-01-01"/>
				</div>
				<div class="div-contenedora-reservas">
					<div class="div-contenerdora-reservas-mañana">
						<div class="div-barra-reservas">
							<h2>Reservas 12:00 a 18:00</h2>
							<h3 class="flecha" id="flecha-mañana" onclick="cambiarMostrar('mañana')">&#9660;</h3>
						</div>
						<div class="div-reservas" id="div-reservas-mañana">

						</div>
					</div>
					<div class="div-contenerdora-reservas-tarde">
						<div class="div-barra-reservas">
							<h2>Reservas 18:00 a 23:00</h2>
							<h3 class="flecha" id="flecha-tarde" onclick="cambiarMostrar('tarde')">&#9660;</h3>
						</div>
						<div class="div-reservas" id="div-reservas-tarde">

						</div>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			const inputFechaReserva = document.querySelector('#fechaReserva');

			var fechaActual = new Date();
			fechaActual.setHours(0);
			fechaActual.setMinutes(0);
			inputFechaReserva.setAttribute("min",fechaActual.toISOString().substring(0,10))

			const divReservasMañana = $('#div-reservas-mañana');
			const divReservasTarde = $('#div-reservas-tarde');

			inputFechaReserva.addEventListener('change', function (e) {
				divReservasMañana.empty();
				divReservasTarde.empty();

				var fechaReserva = new Date(inputFechaReserva.value);

				if(fechaReserva != "Invalid Date" && fechaReserva>=fechaActual){
					var StringFechaReserva = fechaReserva.toISOString().substring(0,10)
					StringFechaReserva = StringFechaReserva.replace("-","").replace("-","");
					
					const refReservasmañana = firebase.database().ref('Reservas/' + StringFechaReserva+"01")
					.orderByChild("horaLlegada");
					refReservasmañana.on('child_added', (reserva) => {
						if(reserva.key != "numTotalReservas"){
							divReservasMañana.append(htmlReserva(reserva));
						}
					});
					
					const refReservasTarde = firebase.database().ref('Reservas/' + StringFechaReserva+"02")
					.orderByChild("horaLlegada");
					refReservasTarde.on('child_added', (reserva) => {
						if(reserva.key != "numTotalReservas"){
							divReservasTarde.append(htmlReserva(reserva));
						}
					});
				}
			});

			function htmlReserva(reserva){
				if(reserva.val().minutoLlegada<10){
					minuto = "0" + reserva.val().minutoLlegada;
				}else{
					minuto = reserva.val().minutoLlegada;
				}
				return '<div class="reserva">'+
					'<div class="fecha-hora">'+
						'<div class="fecha">'+
							'<p>'+reserva.val().dia+'/'+reserva.val().mes+'/'+reserva.val().anno+'</p>'+
						'</div>'+
						'<div class="hora">'+
							'<p>'+reserva.val().horaLlegada+':'+minuto+'</p>'+
						'</div>'+
					'</div>'+
					'<div class="nombreReserva-numeroPersonas">'+
						'<div class="nombreReserva">'+
							'<p>Rerserva a nombre de: <span>'+reserva.val().nombre+'</span></p>'+
						'</div>'+
						'<div class="numeroPersonas">'+
							'<p>Reserva para <span>'+reserva.val().numPersonas+'</span> personas</p>'+
						'</div>'+
					'</div>'+
				'</div>';
			}

			function cambiarMostrar(franja){
				if($('#div-reservas-'+franja).css("display") == "block"){
					$('#div-reservas-'+franja).css("display","none");
					$('#flecha-'+franja).html("&#9650;");
				}else{
					$('#div-reservas-'+franja).css("display","block");
					$('#flecha-'+franja).html("&#9660;");
				}
			}

			ajustarTamaño();
			function ajustarTamaño(){
				registrarseInnerHeight = $(".registrarse").innerHeight();
				marginTop = ($(window).height()-registrarseInnerHeight)/2;
				$(".registrarse").css("margin",marginTop+"px auto");
			}
		</script>
	</body>
</html>